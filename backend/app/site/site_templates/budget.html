{% extends 'base.html' %}

{% block content %} 
    <header class="bg-dark text-success text-center shadow py-3">
        <div class="container p-5 bg-dark">
            <div class="row">
                <div class="d-md-flex bg-dark align-items-center justify-content-evenly">
                    <h1 class="col text-center">{{ current_user.first_name }}'s Budget</h1>
                </div>
            </div>
        </div>
    </header>

    <div style="background-image: url('../../static/img/budgetBackground.jpg'); background-size: cover;" class="vh-100">
        <div class="container">
            <div class="row text-center" id="budget_header">
                <div class="col-4">
                    <h2>Total Income:</h2>
                    <input type="number" name="income" id="income" onkeyup="handleKeyUp(event, 'income')">
                </div>
                <div class="col-4">
                    <h2>Total Expenses:</h2>
                    <input type="text" name="total_expenses" id="total_expenses">
                </div>
                <div class="col-4">
                    <h2>Surplus/Deficit:</h2>
                    <input type="text" name="surplus_deficit" id="surplus_deficit">
                </div>
            </div>

            <div class="row text-center">
                <div class="col-4">
                    <h4>Needs</h4>
                </div>
                <div class="col-4">
                    <h4>Savings</h4>
                </div>
                <div class="col-4">
                    <h4>Wants</h4>
                </div>
            </div>
      
            <div class="row">
                <div class="col-4">
                    <div class="grid-container text-success" id="needs">
                        <div class="grid-item bg-dark border-gray">
                            <h5>Housing</h5>
                            <input type="number" name="housing">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Transportation</h5>
                            <input type="number" name="transportation">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Groceries</h5>
                            <input type="number" name="groceries">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Utilities</h5>
                            <input type="number" name="utilities">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Healthcare</h5>
                            <input type="number" name="healthcare">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Debt Payments</h5>
                            <input type="number" name="debt_payments">
                        </div>
                        <div class="grid-item bg-dark">
                            <button onclick="showExpensePopup('needs')">Add Expense</button>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="grid-container text-success" id="savings">
                        <div class="grid-item bg-dark border-gray">
                            <h5>Emergency Fund</h5>
                            <input type="number" name="emergency_fund">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Retirement</h5>
                            <input type="number" name="retirement">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Vacation</h5>
                            <input type="number" name="vacation">
                        </div>
                        <div class="grid-item bg-dark">
                            <button onclick="showExpensePopup('savings')">Add Expense</button>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="grid-container text-success" id="wants">
                        <div class="grid-item bg-dark border-gray">
                            <h5>Entertainment</h5>
                            <input type="number" name="entertainment">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Dining Out</h5>
                            <input type="number" name="dining_out">
                        </div>
                        <div class="grid-item bg-dark border-gray">
                            <h5>Hobbies</h5>
                            <input type="number" name="hobbies">
                        </div>
                        <div class="grid-item bg-dark">
                            <button onclick="showExpensePopup('wants')">Add Expense</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="expense-popup" class="expense-popup bg-dark text-success">
        <div class="expense-popup-content">
            <h4>Add Expense</h4>
            <input type="text" id="expense-name-input" placeholder="Expense Name" required>
            <input type="number" id="expense-value-input" placeholder="Expense Value">
            <div class="expense-popup-actions">
                <button onclick="saveExpense()">Save</button>
                <button onclick="closePopup()">Cancel</button>
            </div>
        </div>
    </div>

    
    <script>
        const token = "{{ current_user.token }}"
        let currentData = {};

        /* Check to see if data already exists for user. If so, call updateBudgetPage() to set data.
        If not, call createDefaultData() to set initial values in database for said user */
        function checkForData() {
            fetch('/api/checkexpenses', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': 'Bearer ' + token
                },
            })
            .then(response => {
                if (!response.ok) {
                    alert('Failed to get the data. Please try again.');
                } else {
                    response.json()
                    .then(data => {
                        currentData = data
                        console.log(data);
                        if (typeof data === 'string' && data === "User and/or data not found") {
                            console.log('No data found, creating default data...');
                            createDefaultData();
                        } else {
                            updateBudgetPage(currentData);
                        }
                    })
                    .catch(error => {
                        console.error('Error parsing JSON:', error);
                        alert('An error occurred while parsing JSON. Please try again.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }


        /* Create default data - each monetary category to value of 0, create user_id using UUID,
        and get user_token from User table to tie to Expense table */
        function createDefaultData() {
            fetch('/api/createexpenses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': 'Bearer ' + token
                },
                body: JSON.stringify()
            })
            .then(response => {
                if (response.ok) {
                    // Fetch the data again after creating default data
                    fetch('/api/checkexpenses', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-access-token': 'Bearer ' + token
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentData = data
                        updateBudgetPage(currentData)
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        alert('An error occurred while fetching data. Please try again.');
                    });
                } else {
                    alert('Failed to create default data. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }


        checkForData()


        // Calculate the total expenses by getting the sum of all values in each expense category
        function calculateTotalExpenses(expense_list) {
            let totalExpenses = 0;
            console.log(expense_list)
            for (const category in expense_list) {
                if (expense_list.hasOwnProperty(category)) {
                    totalExpenses += expense_list[category];
                }
            }
            return totalExpenses;
        }


        // Get values for income, total_expenses, and surplus_deficit from database and set data in respective spots in HTML
        function updateBudgetPage(currentData) {
            document.getElementById('income').value = currentData.income;
            document.getElementById('total_expenses').value = currentData.total_expenses;
            document.getElementById('surplus_deficit').value = currentData.surplus_deficit;

        // Update expense input values for each category.
            for (const category in currentData.expense_list) {
                if (currentData.expense_list.hasOwnProperty(category)) {
                    const expenseValue = currentData.expense_list[category];
                    const expenseInput = document.querySelector(`input[name="${category}"]`);
                    if (expenseInput) {
                        expenseInput.value = expenseValue;
                    }
                }
            }
        }


        // Function to update data in database when user changes data in any expense category or the total income
        function updateData() {
            // Get updated values from input boxes, then calculate total_expenses and surplus_deficit
            const income = parseFloat(document.getElementById('income').value);
            const expense_list = {};
            for (const category in currentData.expense_list) {
                if (currentData.expense_list.hasOwnProperty(category)) {
                    const inputValue = parseFloat(document.querySelector(`input[name="${category}"]`).value);
                    expense_list[category] = inputValue;
                }
            }
            const total_expenses = calculateTotalExpenses(expense_list)
            const surplus_deficit = income - total_expenses

            // Save updated data to the database
            fetch('/api/updateexpenses', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': 'Bearer ' + token
                },
                body: JSON.stringify({
                    income: income,
                    expense_list: expense_list,
                    total_expenses: total_expenses,
                    surplus_deficit: surplus_deficit
                })
            })
            .then(response => response.json())
            .then(data => {
                // Call updated data back from database after updating and set values on page
                currentData = data
                updateBudgetPage(currentData);
            })
            .catch(error => {
                console.error('Error updating data:', error);
                alert('An error occurred while updating data. Please try again.');
            });
        }


        // Function to handle updating data based on input value change
        function handleInputValueChange(input, category) {
            const inputValue = parseFloat(input.value);
            const storedValue = currentData.expense_list[category];
            
            if (!isNaN(inputValue) && inputValue !== storedValue) {
                updateData();
            }
        }

        // Add blur event listeners to input boxes
        const inputBoxes = document.querySelectorAll('input[type="number"]');
        inputBoxes.forEach(input => {
            input.addEventListener('blur', event => {
                const category = event.target.getAttribute('name');
                handleInputValueChange(event.target, category);
            });
        });

        // Add keyup event listener for Enter key to update values
        document.addEventListener('keyup', event => {
            if (event.key === 'Enter') {
                const activeInput = document.activeElement;
                if (activeInput.tagName === 'INPUT' && activeInput.type === 'number') {
                    const category = activeInput.getAttribute('name');
                    handleInputValueChange(activeInput, category);
                }
            }
        });

        
        
        function showExpensePopup(category) {
            let popup = document.getElementById("expense-popup");
            console.log(popup)
            popup.style.display = "block";

            let expenseNameInput = document.getElementById("expense-name-input");
            expenseNameInput.value = '';

            let expenseValueInput = document.getElementById("expense-value-input");
            expenseValueInput.value = '';

            popup.setAttribute('data-category', category);
            console.log(popup)
        }

        function saveExpense() {
            
            let expenseNameInput = document.getElementById('expense-name-input');
            let expenseValueInput = document.getElementById('expense-value-input');
            let category = document.getElementById('expense-popup').getAttribute('data-category');

            let expenseName = expenseNameInput.value;
            console.log(expenseName)
            let expenseValue = expenseValueInput.value;
            console.log(expenseValue)

            if (!expenseName) {
                alert('Expense name is required.');
                return;
            }

            currentData.expense_list[expenseName] = parseFloat(expenseValue);

            // Update data in database with new expense included
            

            // Add the expense to the grid
            let expenseSection = document.createElement('div');
            expenseSection.classList.add('grid-item', 'bg-dark', 'border-gray');

            let expenseNameHeader = document.createElement('h5');
            expenseNameHeader.textContent = expenseName;
            expenseSection.appendChild(expenseNameHeader);

            let newExpenseValueInput = document.createElement('input');
            newExpenseValueInput.type = 'number';
            newExpenseValueInput.value = expenseValue;
            newExpenseValueInput.name = expenseName;
            expenseSection.appendChild(newExpenseValueInput);
            
            console.log(category)
            let container = document.getElementById(category)
            console.log(container)

            container.insertBefore(expenseSection, container.lastElementChild);
            console.log(currentData)
            updateData(currentData);

            closePopup();
        }

        function closePopup() {
            let popup = document.getElementById("expense-popup");
            popup.style.display = "none";
        }
    </script>

{% endblock %}